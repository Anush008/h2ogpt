
pipeline {
    agent {
        label "linux && docker"
    }

    parameters {
        string(name: 'BRANCH_TAG', defaultValue: 'devops/chathurinda/nightly-pipeline')
    }

    options {
        ansiColor('xterm')
        timestamps()
    }

    stages {
        stage('Init'){
            steps {
                script {
                    currentBuild.displayName = "${env.BUILD_ID} - [${params.BRANCH_TAG}]"
                }
            }
        }
        stage('Build & Push') {
            steps {
                script {
                    withCredentials([file(credentialsId: "MM_GCR_VORVAN_CREDENTIALS", variable: 'GCR_JSON_KEY')]) {
                        sh "docker login gcr.io -u _json_key --password-stdin < ${GCR_JSON_KEY}"
                        sh "make docker_build_runner"
                    }
                }
            }
        }
    }
}
